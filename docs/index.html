<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>EthereumHacker | A Black Ops Ethereum Game</title>
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono:wght@300;400;600&family=Inter&display=swap" rel="stylesheet"> 
    <style>
      html { background-color: #000; background: url(img/bkg.png) no-repeat center center fixed; -webkit-background-size: cover;-moz-background-size: cover;-o-background-size: cover;background-size: cover; height: 100%; }
      body { font-family: "Share Tech Mono", sans-serif; color: #CCC; margin: 0px; background: #00000088; height: 100%; }
      button { width: 120px; height: 30px; border: 2px solid #CCC; border-radius: 3px; background: #000; color: #CCC; cursor: pointer; margin: 5px; box-shadow: 0 0 6px 0 rgba(157, 96, 212, 0.5); border: solid 2px transparent; background-image: linear-gradient(rgba(255, 255, 255, 0), rgba(255, 255, 255, 0)), linear-gradient(101deg, #2878a3, #8a1a86); background-origin: border-box; background-clip: content-box, border-box; box-shadow: 2px 1000px 1px #000 inset; }
      input[type=text] { width: 80px; height: 24px; }
      th { border-bottom: 1px solid #444; font-size: 1.1em; }
      img { max-width: 100%; }
      a { color: #2878a3; }
      ::-webkit-scrollbar { width: 10px; }
      ::-webkit-scrollbar-track { box-shadow: inset 0 0 5px #222; border-radius: 15px; }
      ::-webkit-scrollbar-thumb { background-color: #333; border-radius: 15px; }
      div { scrollbar-color: #333 #111; }
      @media screen and (max-width: 1020px) {
        .mobile-hidden { display: none; }
        #main { display: none !important; }
        #mobile-message { display: block !important; }
      }
    </style>
  </head>
  <body>
    <div id="menu" style="display: none; position: fixed; left: 0; right: 0; top: 0; bottom: 0; background: #000000AA;">
      <div style="position: fixed; left: 10%; right: 10%; top: 75px; bottom: 10%; border: 5px solid #222; background: #000; text-align: center;">
        <h3><span style="color: #2878a3; font-weight: 300; font-size:1.2em; letter-spacing: .15rem;"><span style="font-size: 1.2em;">E</span>THEREUM<span style="color: #8a1a86;"><span style="font-size: 1.2em;">H</span>ACKER</span></span> Series 1</h3>
        <div style="display: flex; flex-direction: row; align-items: top; justify-content: center; width: 100%; height: 40%;">
          <div style="flex: 1 1 0; cursor:pointer; border: 3px solid #111; padding: 3px; margin: 5px; background-image: url(img/level1-thumb.png); background-size: cover;" onclick="level1();">
            <h2 style="margin: 15px 0px; color: #2878a3;">THE GALA NFT</h2>
            <h3 style="margin: 0px;">Episode 1 - Easy</h3>
            <p style="color: #888;">Help get our agent into the Gala NFT Party by hacking a NFT contract</p>
            <p id="s1e1" style="margin-top: 10px; color: #8a1a86; font-size: 1.4em;">&nbsp;</p>
          </div>
          <div style="flex: 1 1 0; cursor:pointer; border: 3px solid #111; padding: 3px; margin: 5px; background-image: url(img/level2-thumb.png); background-size: cover;" onclick="level2();">
            <h2 style="margin: 15px 0px; color: #2878a3;">FIND THE WHALE</h2>
            <h3 style="margin: 0px;">Episode 2 - Easy</h3>
            <p style="color: #888;">There is a large token holder at the party, let's uncover who they are</p>
            <p id="s1e2" style="margin-top: 10px; color: #8a1a86; font-size: 1.4em;">&nbsp;</p>
          </div>
          <div style="flex: 1 1 0; cursor:pointer; border: 3px solid #111; padding: 3px; margin: 5px; background-image: url(img/level3-thumb.png); background-size: cover;" onclick="level3();">
            <h2 style="margin: 15px 0px; color: #2878a3;">HACK THE ORACLE</h2>
            <h3 style="margin: 0px;">Episode 3 - Medium</h3>
            <p style="color: #888;">This contract isn't as permissionless as one would hope</p>
            <p id="s1e3" style="margin-top: 10px; color: #8a1a86; font-size: 1.4em;">&nbsp;</p>
          </div>
        </div>
        <div style="display: flex; flex-direction: row; align-items: top; justify-content: center; width: 100%; height: 40%;">
          <div style="flex: 1 1 0; cursor:pointer; border: 3px solid #111; padding: 3px; margin: 5px; background-image: url(img/level4-thumb.png); background-size: cover;" onclick="level4();">
            <h2 style="margin: 15px 0px; color: #2878a3;">MARKET MANIPULATION</h2>
            <h3 style="margin: 0px;">Episode 4 - Medium</h3>
            <p style="color: #888;">Prevent price fixing in the central bank digital currency</p>
            <p id="s1e4" style="margin-top: 10px; color: #8a1a86; font-size: 1.4em;">&nbsp;</p>
          </div>
          <div style="flex: 1 1 0; cursor:pointer; border: 3px solid #111; padding: 3px; margin: 5px; background-image: url(img/level5-thumb.png); background-size: cover;" onclick="level5();">
            <h2 style="margin: 15px 0px; color: #2878a3;">BREAK THE MULTISIG</h2>
            <h3 style="margin: 0px;">Episode 5 - Hard</h3>
            <p style="color: #888;">Break a multisignature wallets safety function to gain access to the funds</p>
            <p id="s1e5" style="margin-top: 10px; color: #8a1a86; font-size: 1.4em;">&nbsp;</p>
          </div>
          <div style="flex: 1 1 0; cursor:pointer; border: 3px solid #111; padding: 3px; margin: 5px; background-image: url(img/level6-thumb.png); background-size: cover;" onclick="level6();">
            <h2 style="margin: 15px 0px; color: #2878a3;">GRADUATION</h2>
            <h3 style="margin: 0px;">Episode 6 - Medium</h3>
            <p style="color: #888;">Finish up by adding your name to the leaderboard</p>
            <p id="s1e6" style="margin-top: 10px; color: #8a1a86; font-size: 1.4em;">&nbsp;</p>
          </div>
        </div>
        <div style="position: absolute; bottom: 10px; width:100%; text-align: center; color: #8a1a86; font-size: 1.2em;"><a href="javascript:void(0)" onclick="leaderBoard();">Leaderboard</a> / <a href="https://github.com/jamesbachini/EthereumHacker/" target="_blank">Github</a> / <a href="https://twitter.com/james_bachini" target="_blank">Twitter</a> / <a href="https://www.youtube.com/c/JamesBachini?sub_confirmation=1" target="_blank">YouTube</a></div>
      </div>
    </div>

    <div style="display: flex; flex-direction: row; align-items: center; justify-content: center; width: 100%;">
      <div style="flex: 1 1 auto; text-align: left; font-size: 1.4em; font-weight: bold;">
        <img src="img/logo.svg?v2=3" style="height:60px; margin-bottom: -20px; margin-left: 10px;" />
        <span style="color: #2878a3; font-weight: 300; font-size:1.2em; letter-spacing: .15rem;"><span style="font-size: 1.2em;">E</span>THEREUM<span style="color: #8a1a86;"><span style="font-size: 1.2em;">H</span>ACKER</span></span>
        <div style="font-size: 0.82em; margin-left: 83px; color: #555;">BLACK OPS ETHEREUM GAME</div>
      </div>
      <div style="flex: 1 1 auto; text-align: right; padding: 1%;">
        <span style="font-size:0.6em; color: #333;" class="wallet-address"></span>
        <button id="connect">CONNECT</button>
        <img src="img/menu.svg" style="cursor: pointer; height: 26px; margin-bottom: -8px;" onclick="menu();" />
      </div>
    </div>

    <div id="main" style="display: flex; flex-direction: row; align-items: top; justify-content: center; width: 100%; height: 80%;">
      <div id="panel1" style="flex: 2 1 0; background: #000000AA; height: 100%; border: 5px solid #222; margin: 1%; padding: 1%; overflow: hidden;">
        <div id="instructions" style="height: 100%; overflow-x: hidden; overflow-y: scroll; overflow-wrap: break-word; word-break: break-word; padding-right: 15px;"></div>
      </div>
      <div id="panel2" style="flex: 1 1 0; background: #000000AA; height: 100%; border: 5px solid #222; margin: 1%; padding: 1%; overflow: hidden;">
        <div style="display: flex; flex-direction: column; height: 100%;">
          <div id="coms" style="flex: 8 1 0; overflow-x: hidden; overflow-y: scroll; height: 100%; overflow-wrap: break-word; word-break: break-word; padding-right: 15px;"></div>
          <div id="chat" style="flex: 1 1 0;">
            <input type="text" id="user-message" style="width: 70%;" />
            <button id="send-message" style="width: 20%;">SEND</button>
          </div>
        </div>
      </div>
    </div>

    <div id="intro" style="position: fixed; left: 0; right: 0; top: 75px; bottom: 0; display: none; background: #000000EE; text-align: center;">
      <div id="intro-text" style="color: #0F0; font-size: 1.2em; margin: 5% auto; text-align: left; width: 600px;"></div>
      <button id="skip-intro" onclick="skipIntro()" style="">SKIP INTRO</button>
    </div>

    <div id="mobile-message" style="position: fixed; left: 0; right: 0; top: 75px; bottom: 0; display: none; background: #000000EE; padding: 5%;">Unfortunately it is not currently possible to play on a mobile device.<br><br>You will need to use remix, metamask and etherscan to complete the challenges so log in to a laptop and join your team</div>

    <div id="leaderboard" style="position: fixed; left: 0; right: 0; top: 75px; bottom: 0; display: none; background: #000000EE; padding: 5%;">
      <div style="width: 100%; text-align: center; margin: 5px;">
        <button onclick="document.getElementById('leaderboard').style.display = 'none';">CLOSE</button>
      </div>
      <div id="leaderboard-content" style="display: flex; flex-direction: row; align-items: top; justify-content: center; width: 100%; height: 90%;">
       <div id="leaders-first" style="flex: 1 1 0; background: #000000AA; height: 100%; border: 5px solid #222; margin: 1%; padding: 1%; overflow: hidden;">Loading...</div>
       <div id="leaders-latest" style="flex: 1 1 0; background: #000000AA; height: 100%; border: 5px solid #222; margin: 1%; padding: 1%; overflow: hidden;">Loading...</div>
      </div>
    </div>

    <script src="https://cdn.ethers.io/lib/ethers-5.2.umd.min.js" type="application/javascript"></script>
    <script>
      let provider; 
      let signer;
      let userAddress;

      const connect = async () => {
        provider = new ethers.providers.Web3Provider(window.ethereum, "any");
        await provider.send("eth_requestAccounts", []);
        signer = provider.getSigner()
        userAddress = await signer.getAddress();
        const { chainId } = await provider.getNetwork()
        if (chainId !== 5) alert('Please set your network to "Goerli Test Network"');
        document.querySelectorAll('.wallet-address').forEach(el => el.innerHTML = `${userAddress.substr(0,8)}...`);
        document.getElementById('connect').innerHTML = 'CONNECTED';
        window.ethereum.on('accountsChanged', () => { connect() });
        window.ethereum.on('network', () => { connect() });
      }
      document.getElementById('connect').onclick = connect;

      let level = {};

      const addInstructions = async (html) => {
        const formattedHTML = `<div style="display: flex; flex-direction: row; align-items: top;"><div style="font-weight: bold; color: #2878a3;">&gt;</div><div style="padding-left: 10px; color: #0F0;">${html}</div></div><hr style="width: 100%; margin: 20px 0px; color: #111;">`;
        document.getElementById('instructions').innerHTML += formattedHTML;
        document.getElementById('instructions').scrollTop = document.getElementById('instructions').scrollHeight;
      }

      const addComs = async (who,html) => {
        const formattedHTML = `<div style="display: flex; flex-direction: row; align-items: center; margin-top: 10px;"><div><img src="img/${who.toLowerCase()}.png" alt="${who}" style="height: 80px; min-width: 80px; border: 2px solid #2878a3; border-radius: 99px;" /></div><div style="padding-left: 20px;"><div style="color:#2878a3; font-weight:bold;">${who}</div><div>${html}</div></div></div>`;
        document.getElementById('coms').innerHTML += formattedHTML;
        document.getElementById('coms').scrollTop = document.getElementById('coms').scrollHeight;
      }

      const waitForInput = async () => {
        while (!level.newMessage) {
          await wait(1000);
        }
        level.lastMessage = level.newMessage;
        delete level.newMessage;
        return true;
      }

      const userMessage = async () => {
        const msg = document.getElementById('user-message').value;
        level.newMessage = msg;
        addComs('Me',msg);
        document.getElementById('user-message').value = '';
        if (msg.toLowerCase().includes('help')) help();
      }
      document.getElementById('send-message').onclick = userMessage;

      const wait = async (ms) => {
        const currentLevel = level.uniq;
        await new Promise(r => setTimeout(r, ms));
        if (currentLevel !== level.uniq) throw new Error('Level has changed');
        return true;
      }

      const level1 = async () => {
        // The Gala NFT
        await startNewLevel(1);
        level.contract = `0x484Ec30Feff505b545Ed7b905bc25a6a40589181`; // GalaNFT.sol
        await wait(2000);
        addComs('James',`We have a code red and need your help`);
        await wait(4000);
        addComs('Cathy',`I'm trying to get into the gala party but they are scanning for an NFT at the door`);
        await wait(4000);
        addComs('Sophie',`The NFTs are sold out and we need you to figure out a way to hack the contract and mint one`);
        await wait(3000);
        addComs('James',`NFT contract address is: <a href="https://goerli.etherscan.io/address/${level.contract}#code" target="_blank">${level.contract}</a>`);
        await wait(3000);
        addComs('Sophie',`Uploading further instructions to your panel now, message me when you have an NFT in your wallet`);
        await wait(500);
        await addInstructions(`Let's start by getting metamask setup. Download it here and set up a new wallet: <a href="https://metamask.io" target="_blank" />https://metamask.io</a> If you already have metamask it is still worth setting up a new wallet from the one you use for your main funds`);
        await wait(500);
        await addInstructions(`Change the network at the top of metamask to "Goerli Test Network". Testnets are a playground for developers and hackers alike!<br><img src="img/level1-metamask.jpg" style="border: 3px solid #222;" />`);
        await wait(500);
        await addInstructions(`Go ahead and connect your wallet to the EthereumHacker.com platform, click connect in the top right corner of this page and confirm in Metamask.`);
        await wait(500);
        await addInstructions(`Next get some Goerli testnet Ether to work with, there's a faucet here which should work <a href="https://goerli-faucet.pk910.de/" target="_blank">https://goerli-faucet.pk910.de/</a> If not try Googling "Goerli faucet" and see what comes up. You'll need some free testnet ETH to execute transactions. Be careful what you sign on 3rd party sites, you did set up a separate wallet right?`);
        await wait(500);
        await addInstructions(`Now head over to Etherscan and check out that NFT contract: <a href="https://goerli.etherscan.io/address/${level.contract}#code" target="_blank">https://goerli.etherscan.io/address/${level.contract}#code</a> Note you can switch between code, read functions and write functions using these buttons on etherscan.<br><img src="img/level1-etherscan.png" style="max-width: 300px; border: 3px solid #222;" />`);
        await wait(500);
        await addInstructions(`In the "Write Contract" section there is an option to "🔴 Connect To Web3", this will connect your wallet to Etherscan. We can then fire off transactions such as the mint function which when we copy and paste our address from metamask into the "_to" field and click mint should send us an NFT. Unfortunately they've sold out already so you'll have to check the code and figure out a way to hack the contract. Send us a message in the chat window when you have an NFT, good luck.`);
        await wait(500);
        document.getElementById('instructions').scrollTop = 0;
        setTimeout(() => {
          if (level.id !== 1) return false;
          addComs('James',`I've found a function called increaseMaxSupply(), maybe we can call this from Etherscan before we mint to our wallet address?`);
        }, 5 * 60000);
        while (!level.complete) {
          await waitForInput();
          if(!userAddress) await connect();
          level.abi = ["function balanceOf(address owner) view returns (uint balance)"];
          level.interface = new ethers.Contract(level.contract, level.abi, signer);
          const checkBalance = await level.interface.balanceOf(userAddress);
          level.complete = checkBalance.toNumber();
          if (level.complete) {
            addComs('James',`Great work! You have completed the first level and are set up to take on your next challenge`);
            localStorage.setItem('s1e1', true);
            await wait(5000);
            menu();
          } else {
            addComs('Sophie',`I'm not seeing the NFT in your wallet, use the balanceOf() function on Etherscan's "Read Functions" tab to check`);
          }
        }
      }

      const level2 = async () => {
        // Find The Whale
        await startNewLevel(2);
        level.contract = `0x484Ec30Feff505b545Ed7b905bc25a6a40589181`; // GalaNFT.sol
        await wait(1000);
        addComs('Cathy',`Good work on the NFT, I'm in! Now we need to find out who is behind this`);
        await wait(2000);
        addComs('Sophie',`If we can find the whale's wallet address that might give us some clues as to who it is. What do we know about them?`);
        await wait(4000);
        addComs('James',`We know they hold a bunch of the Gala NFT's including Token ID 45, perhaps we can write some code in Remix to figure out which address it is...`);
        await wait(4000);
        addComs('James',`Here is that NFT contract address again: <a href="https://goerli.etherscan.io/address/${level.contract}#code" target="_blank">${level.contract}</a> Sophie will provide some instructions on setting up a smart contract to figure this out`);
        await wait(3000);
        addComs('Sophie',`On it`);
        await wait(500);
        await addInstructions(`Head over to <a href="https://remix.ethereum.org" target="_blank">https://remix.ethereum.org</a> this is an online Solidity code editor which we can connect to the Goerli testnet via metamask. We are going to use it to write a simple smart contract and expose the whale.`);
        await wait(500);
        await addInstructions(`On the left hand side we can navigate to the contracts folder, then create a new file and call it Whale.sol like in this screenshot.<br><img src="img/level2-newfile.jpg" style="border: 3px solid #222; width: 300px;" />`);
        await wait(500);
        await addInstructions(`If you can figure out how to do it from here then go ahead if not type help in the chat window and the team can assist you. Once you know the whale's address send it via the chat window.`);
        await wait(500);
        setTimeout(async () => {
          if (level.id !== 2) return false;
          addComs('James',`We should probably import the Openzeppelin interface to connect to the contract. I'll put an example of what I'm thinking in the terminal:`);
          await wait(1000);
          await addInstructions(`
<pre><code>
// SPDX-License-Identifier: GPL-3.0
pragma solidity ^0.8.0;

import "@openzeppelin/contracts/token/ERC721/IERC721.sol";

contract Whale {
    function checkBalance() public view returns (uint256) {
        return IERC721(${level.contract}).balanceOf(msg.sender);
    }
}
</code></pre>`);
          await wait(1000);
          addComs('James',`That's close but it's not quite right. Once you have it figured out deploy the contract to Goerli and run the function. Sophie will provide further instructions on that shortly. Type help in here if you need some assistance`);
        }, 30000);
        setTimeout(async () => {
          if (level.id !== 2) return false;
          addComs('Sophie',`Let's go through how to compile and deploy a contract using Remix. You can copy and paste the example in the instructions to start with or use your own`);
          await wait(1000);
          await addInstructions(`In Remix, on the left hand side tool bar, the 3rd item down is a little "S" shaped icon. Click that and it should take you to the compile page. Click the big blue button that says "Compile Whale.sol". Any errors in your contract will usually show up here`);
          await wait(3000);
          await addInstructions(`Next tool bar icon down is an Ethereum shaped icon. Click that and it should take you to the deploy page.<ul><li>Change Environment to "Injected Web3"</li><li>Change Contract to "Whale - contracts/Whale.sol"</li><li>Click deploy and confirm the transaction in Metamask</li><li>At the bottom of that task bar there is a section for deployed contracts</li><li>Expand yours and you should have buttons for the contract functions</li></ul><br><img src="img/level2-contract.jpg" style="border: 3px solid #222; width: 300px;" />`);
        }, 90000);
        while (!level.complete) {
          await waitForInput();
          if (level.lastMessage.toLowerCase().includes('0x123e710c69b6806ef32cf52e49dcc5eeec368a22')) level.complete = true;
          if (level.complete) {
            addComs('James',`Got him. Great work! Let's Go`);
            localStorage.setItem('s1e2', true);
            await wait(5000);
            menu();
          }
        }
      }

      const level3 = async () => {
        // Hack The Oracle
        await startNewLevel(3);
        level.contract = `0x094251c982cb00B1b1E1707D61553E304289D4D8`; // CBDC.sol
        await wait(1000);
        addComs('Sophie',`There is an ERC20 token in the whales wallet which I think might be the central bank digital currency. It's at token address: <a href="https://goerli.etherscan.io/address/${level.contract}#code" target="_blank">${level.contract}</a>`);
        await wait(3000);
        addComs('Cathy',`We can't let them launch a CBDC. Is it possible to break it?`);
        await wait(4000);
        addComs('James',`Looking at the code there are oracles that have special privileges. If we can get your address whitelisted as an oracle then we might be able to do something`);
        await wait(3000);
        addComs('Sophie',`There is a function addOracle() but it's secured by a secret hash. We will need the right code word or phrase to do this`);
        await wait(4000);
        addComs('Cathy',`The profile suggests they are likely to use a single word that is all lowercase. Let us know when you've done it. Good luck!`);
        await addInstructions(`Search the code for any clues about what the secret word is`);
        await wait(500);
        await addInstructions(`Execute the addOracle() function with the secret word to add your address to the oracles`);
        await wait(500);
        await addInstructions(`Type help in chat if you need the team`);
        await wait(500);
        
        while (!level.complete) {
          await waitForInput();
          if(!userAddress) await connect();
          level.abi = ["function isOracle(address _checkAddress) public view returns (bool)"];
          level.interface = new ethers.Contract(level.contract, level.abi, signer);
          level.complete = await level.interface.isOracle(userAddress);
          console.log(level.complete);
          if (level.complete) {
            addComs('James',`That's it you have oracle privileges. Amazing. Well done!`);
            localStorage.setItem('s1e3', true);
            await wait(5000);
            menu();
          } else {
            addComs('Sophie',`Your wallet isn't currently registered as an oracle`);
            
          }
        }
      }

      const level4 = async () => {
        // Stop Market Manipulation
        await startNewLevel(4);
        level.contract = `0x094251c982cb00B1b1E1707D61553E304289D4D8`; // CBDC.sol
        level.priceTarget = Math.round((Math.random() * 990) + 10);
        await wait(1000);
        addComs('James',`They are manipulating markets by setting a USD price within the smart contract. We need to reduce the USD price`);
        await wait(3000);
        addComs('Cathy',`Market intelligence suggest a price target of $${level.priceTarget} would be ideal to counteract them`);
        await wait(4000);
        addComs('James',`Let's have a look at that token contract again: <a href="https://goerli.etherscan.io/address/${level.contract}#code" target="_blank">${level.contract}</a>`);
        await wait(3000);
        addComs('Sophie',`There is a updatePrice() function but you'll need to write a smart contract to break this one`);
        await wait(4000);
        addComs('Cathy',`Make sure you set the price to $${level.priceTarget} and then let us know here when it's done. As always just ask for help in chat if you need it`);
        await addInstructions(`Check out the contract code and updatePrice() function at <a href="https://goerli.etherscan.io/address/${level.contract}#code" target="_blank">${level.contract}</a>`);
        await wait(500);
        await addInstructions(`Head over to Remix and create a new contract <a href="https://remix.ethereum.org" target="_blank">https://remix.ethereum.org</a>`);
        await wait(500);
        await addInstructions(`There's two stages to this. We will need to add our contract address to the list of oracles using the secret word from the last challenge. Then we need to crack the block hash which we will need to do programmatically because it changes every 13 seconds`);
        await wait(500);
        await addInstructions(`Here's an interface we can use to interact with the CBDC token contract
<pre><code>
// SPDX-License-Identifier: GPL-3.0
pragma solidity ^0.8.0;

interface CBDC {
  function addOracle(string calldata _secret) external;
  function updatePrice(bytes32 _blockHash, uint256 _usdPrice) external;
}

contract PriceUpdater {
    address cbdc = 0x094251c982cb00B1b1E1707D61553E304289D4D8;
    function updatePrice(string calldata _secret) public {    
        CBDC(cbdc).addOracle(_secret);
    }
}
</code></pre>`);
        await wait(500);
        while (!level.complete) {
          await waitForInput();
          if(!userAddress) await connect();
          level.abi = ["function usdPrice() public view returns (uint256)"];
          level.interface = new ethers.Contract(level.contract, level.abi, signer);
          const usdPrice = await level.interface.usdPrice();
          if (usdPrice.toNumber() == level.priceTarget) level.complete = true;
          if (level.complete) {
            addComs('James',`Price target is hit! Our market makers can do the rest 👍`);
            localStorage.setItem('s1e4', true);
            await wait(5000);
            menu();
          } else {
            addComs('Sophie',`usdPrice is currently $${usdPrice.toNumber()} we need you to set it to $${level.priceTarget}`);
          }
        }
      }

      const level5 = async () => {
        // Break The Multisig
        await startNewLevel(5);
        level.contract = `0x550714e1Fd747084Fc5cB2B2e3a93512972aeBdA`; // MultiSig.sol
        level.tokenContract = `0x094251c982cb00B1b1E1707D61553E304289D4D8`; // CBDC.sol
        await wait(1000);
        addComs('Cathy',`We have a problem. The vast majority of the CBDC funds are held in a multisig wallet which I can't access.`);
        await wait(3000);
        addComs('Sophie',`I see the multisig here: <a href="https://goerli.etherscan.io/address/${level.contract}#code" target="_blank">${level.contract}</a>`);
        await wait(4000);
        addComs('James',`OK we need a way to access those tokens. Can you hack it and show that you have some of those CBDC's in your wallet?`);
        await wait(3000);
        addComs('Sophie',`You'll need the CDBC contract address too I expect: <a href="https://goerli.etherscan.io/address/${level.tokenContract}#code" target="_blank">${level.tokenContract}</a>`);
        await wait(500);
        await addInstructions(`You are going to need to use Remix for this and deploy a contract to exploit the MultiSig contract <a href="https://remix.ethereum.org" target="_blank">https://remix.ethereum.org</a>`);
        await addInstructions(`Setup interfaces to interact with the functions you need on the external contracts`);
        await wait(500);
        await addInstructions(`Deploy your attacker contract and execute it to take some CDBC tokens`);
        await wait(500);
        await addInstructions(`Put a message in chat when you have some CBDC tokens in your wallet or type help if you need assistance`);
        while (!level.complete) {
          await waitForInput();
          if(!userAddress) await connect();
          level.abi = ["function balanceOf(address account) public view returns (uint256)"];
          level.interface = new ethers.Contract(level.tokenContract, level.abi, signer);
          const balance = await level.interface.balanceOf(userAddress);
          if (balance.toNumber() > 0) level.complete = true;
          if (level.complete) {
            addComs('James',`You found a way to break that contract, well done! Sophie can automate it from here to drain it 👍`);
            localStorage.setItem('s1e5', true);
            await wait(5000);
            menu();
          } else {
            addComs('Sophie',`Your CBDC balance is currently ${balance.toNumber()} we need some of those tokens`);
          }
        }
      }

      const level6 = async () => {
        // Leaderboard
        await startNewLevel(5);
        level.contract = `0x8ef50fadf9Bd73E44Fc6839D40854F57F0C46Fc9`; // Leaderboard.sol
        await wait(1000);
        addComs('Cathy',`It's time for you to graduate as a certified Ethereum Hacker, let's wrap this up with one final challenge.`);
        await wait(3000);
        addComs('Sophie',`There is a leaderboard contract: <a href="https://goerli.etherscan.io/address/${level.contract}#code" target="_blank">${level.contract}</a>`);
        await wait(4000);
        addComs('James',`You'll need to decode a secret pharse and add your name or handle to the leaderboard.`);
        await wait(3000);
        await addInstructions(`You can probably use <a href="https://remix.ethereum.org" target="_blank">Remix</a> or <a href="https://goerli.etherscan.io/address/${level.contract}#code" target="_blank">Etherscan</a> for this.`);
        await wait(500);
        await addInstructions(`Ensure you've completed the previous challenges first. Then solve the secret phrase in the smart contract at: <a href="https://goerli.etherscan.io/address/${level.contract}#code" target="_blank">${level.contract}</a>`);
        await wait(500);
        await addInstructions(`You will need some of that CBDC in your wallet and also make sure _yourName is less than 32 characters`);
        
        await wait(500);
        await addInstructions(`Send us a message when you have your name in the leaderboard`);
        while (!level.complete) {
          await waitForInput();
          if(!userAddress) await connect();
          level.abi = ["function position(address) public view returns (uint256)"];
          level.interface = new ethers.Contract(level.contract, level.abi, signer);
          const position = await level.interface.position(userAddress);
          if (position.toNumber() > 0) level.complete = true;
          if (level.complete) {
            addComs('James',`Congratulations you are the ${position.toNumber()} person to complete this challenge.`);
            await wait(2000);
            addComs('Cathy',`Your name will forever live in the blockchain`);
            localStorage.setItem('s1e6', true);
            await wait(5000);
            menu();
          } else {
            addComs('Sophie',`You aren't showing on the leaderboard yet`);
          }
        }
      }

      const leaderBoard = async () => {
        if(!userAddress) await connect();
        document.getElementById('leaderboard').style.display = 'block';
        const contract = `0x8ef50fadf9Bd73E44Fc6839D40854F57F0C46Fc9`; // Leaderboard.sol
        const abi = ["function leaderboard(uint256) public view returns (string)","function leaderboardLength() public view returns (uint256)"];
        const interface = new ethers.Contract(contract, abi, signer);
        let first = `<h2>FIRST</h2><ul>`;
        for (let i = 0; i < 5; i++) {
          try {
            const name = await interface.leaderboard(i);
            const cleanName = name.split(/[^a-zA-Z0-9_@\.]/).join('');
            first += `<li>${cleanName}</li>`;
          } catch (e) {
            console.log(e);
          }    
        }
        first += `</ul>`;
        document.getElementById('leaders-first').innerHTML = first;
        const latestRes = await interface.leaderboardLength();
        const noOfPlayers = latestRes.toNumber();
        let latest = `<h2>LATEST</h2><ul>`;
        for (let i = noOfPlayers; i > noOfPlayers-5; i--) {
          try {
            const name = await interface.leaderboard(i);
            const cleanName = name.split(/[^a-zA-Z0-9_@\.]/).join('');
            latest += `<li>${cleanName}</li>`;
          } catch (e) {
            console.log(e);
          }    
        }
        latest += `</ul>`;
        document.getElementById('leaders-latest').innerHTML = latest;
      }

      const help = async () => {
        if (!level.help) level.help = 0;
        if (level.id == 2) {
          if (level.help == 0) addComs('Sophie',`There is an ownerOf() function in that contract which looks interesting...`);
          if (level.help == 1) addComs('James',`We need to modify the contract I sent you to use ownerOf(45) instead of the balanceOf() function.`);
          if (level.help == 2) addComs('James',`Don't forget we need to return an address from the function rather than a number/uint256.`);
          if (level.help == 3) addComs('Sophie',`You can probably find out more about using remix on YouTube if you are stuck`);
          if (level.help > 3) addComs('James',`There's an example contract here which should do it <a href="https://github.com/jamesbachini/EthereumHacker/blob/main/contracts/Whale.sol" target="_blank">https://github.com/jamesbachini/EthereumHacker/blob/main/contracts/Whale.sol</a>`);
        }
        if (level.id == 3) {
          if (level.help == 0) addComs('Sophie',`There's a comment in the code linking to this twitter profile <a href="https://twitter.com/CentralBankDigi" target="_blank">https://twitter.com/CentralBankDigi</a>`);
          if (level.help == 1) addComs('James',`It might be easier to try different answers using the testAnswer() function.`);
          if (level.help == 2) addComs('James',`What has branches but no leaves... Must be something related, financial maybe`);
          if (level.help == 3) addComs('Cathy',`High street shops and banks have branches`);
          if (level.help > 3) addComs('James',`Try the addOracle function with the string bank`);
        }
        if (level.id == 4) {
          if (level.help == 1) addComs('James',`Deploy your attacker contract to Goreli and run it from there to update the usdPrice value.`);
          if (level.help == 0) addComs('Sophie',`Maybe we can copy some of the code from the CBDC.sol contract into ours to crack the blockhash`);
          if (level.help == 2) addComs('James',`Your contract will need to execute the addOracle(_secret) first, then the updatePrice(_blockHash, _newPrice) functions`);
          if (level.help == 3) addComs('Cathy',`You'll need to calculate that blockhash in real time to update the price`);
          if (level.help > 3) addComs('James',`There's a contract I've put together here: <a href="https://github.com/jamesbachini/EthereumHacker/blob/main/contracts/PriceUpdater.sol" target="_blank">https://github.com/jamesbachini/EthereumHacker/blob/main/contracts/PriceUpdater.sol</a> try that.`);
        }
        if (level.id == 5) {
          if (level.help == 1) addComs('James',`Start by reading through the contract and trying to find an attack vector, perhaps something non-obvious.`);
          if (level.help == 0) addComs('Sophie',`If we could control the USDC token address we could use buyFundsPublic() to get some funds.`);
          if (level.help == 2) addComs('James',`You would need to deploy your own ERC20 token, mint yourself a load of it and then replace the USDC contract address with yours.`);
          if (level.help == 3) addComs('Cathy',`Don't forget you need to execute _approve(address(this),multisig,amount) on your own ERC20 to allow the multisig contract to move tokens when calling transferFrom()`);
          if (level.help > 3) addComs('James',`Take a look at this code for inspiration: <a href="https://github.com/jamesbachini/EthereumHacker/blob/main/contracts/MyERC20.sol" target="_blank">https://github.com/jamesbachini/EthereumHacker/blob/main/contracts/MyERC20.sol</a> try that.`);
        }
        if (level.id == 5) {
          if (level.help == 1) addComs('James',`The code is written in hexadecimal format, perhaps we can convert it to a text string.`);
          if (level.help == 0) addComs('Sophie',`There is another function at the bottom of the contract which might help.`);
          if (level.help == 2) addComs('James',`Or maybe just use an online binary > text converter`);
          if (level.help == 3) addComs('Sophie',`The leaderboard code is also here: <a href="https://github.com/jamesbachini/EthereumHacker/blob/main/contracts/Leaderboard.sol" target="_blank">https://github.com/jamesbachini/EthereumHacker/blob/main/contracts/Leaderboard.sol</a>`);
          if (level.help > 3) addComs('James',`"congratulations" on needing this much help`);
        }
        level.help += 1;
      }

      const menu = async () => {
        document.getElementById('menu').style.display = 'block';
        for (let episode = 1; episode <= 6; episode++) {
          if (localStorage.getItem(`s1e${episode}`)) {
            document.getElementById(`s1e${episode}`).innerHTML = 'COMPLETE';
          }
        }
      }

      const startNewLevel = async (id) => {
        level = {
          id,
          uniq: Math.random().toString(36).substring(7),
        };
        document.getElementById('menu').style.display = 'none';
        document.getElementById('coms').innerHTML = '';
        document.getElementById('instructions').innerHTML = '';
      }

      const intro = async () => {
        startNewLevel('intro');
        if (localStorage.getItem('intro')) {
          menu();
          return false;
        }
        document.getElementById('intro').style.display = 'block';
        await type('intro-text','The year is 2032 and a major super power is threatening to launch a central bank digital currency');
        await type('intro-text','This will threaten our global reserve status, the worlds economy and democracy as we know it');
        await type('intro-text','A special team of black ops ethereum hackers has been put together to prevent this happening');
        await type('intro-text','Use your Web3 skills to help the elite team prevent an economic and social collapse of society');
        await wait(5000);
        document.getElementById('intro').style.display = 'none';
        menu();
      }

      const skipIntro = async () => {
        localStorage.setItem('intro', true);
        document.getElementById('intro').style.display = 'none';
        level = {};
        menu();
      }

      const type = async (id,html) => {
        let i = 0;
        while (i < html.length) {
          document.getElementById(id).innerHTML += html.substring(i, i+1)
          i++;
          await wait(40);
        }
        document.getElementById(id).innerHTML += '<br /><br />';
      }

      const init = async() => {
        document.getElementById('user-message').addEventListener('keyup', function(event) {
          event.preventDefault();
          if (event.keyCode === 13) userMessage();
        });
        await wait(500);
        await intro();
      }
      init();
    </script>
  </body>
</html>
